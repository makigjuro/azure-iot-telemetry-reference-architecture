graph TB
    subgraph "On-Premises/Edge"
        IoT[IoT Devices/Sensors<br/>MQTT/AMQP]
        EdgeGateway[IoT Edge Gateway<br/>Local Processing]
    end

    subgraph "Azure Subscription"
        subgraph "Virtual Network: vnet-iot-prod"
            subgraph "Subnet: snet-management"
                VM[Virtual Machines<br/>Management/DevOps]
                Bastion[Azure Bastion]
            end

            subgraph "Subnet: snet-application"
                ACA[Azure Container Apps<br/>Gateway API + Workers]
                PE_KV[Private Endpoint<br/>Key Vault]
                PE_ADLS[Private Endpoint<br/>Data Lake]
                PE_PG[Private Endpoint<br/>PostgreSQL]
                PE_SYN[Private Endpoint<br/>Synapse]
                PE_IOT[Private Endpoint<br/>IoT Hub]
                PE_EH[Private Endpoint<br/>Event Hubs]
            end

            subgraph "Subnet: snet-data"
                Postgres[(Azure PostgreSQL<br/>Flexible Server)]
            end
        end

        subgraph "IoT & Device Management"
            IoTHub[Azure IoT Hub<br/>Device Registry/D2C/C2D]
            DPS[Device Provisioning Service<br/>Zero-touch provisioning]
            DigitalTwins[Azure Digital Twins<br/>Device Models/DTDL]
        end

        subgraph "Ingestion & Event Layer"
            EG[Event Grid<br/>CloudEvents Topic]
            EventHub[Event Hubs<br/>Telemetry Stream]
            StreamAnalytics[Stream Analytics<br/>Real-time Processing]
        end

        subgraph "Storage Layer"
            ADLS[(Data Lake Storage Gen2<br/>Raw/Bronze/Silver/Gold)]
            Blob[Blob Storage<br/>Functions/Logs]
        end

        subgraph "Analytics & Data Platform"
            Synapse[Azure Synapse Analytics<br/>Pipelines/SQL Pools/Spark]
            Fabric[Microsoft Fabric<br/>Lakehouse/Semantic Models]
        end

        subgraph "Security & Secrets"
            KV[Key Vault<br/>Secrets/Certificates/Keys]
            EntraID[Microsoft Entra ID<br/>RBAC/Managed Identities]
        end

        subgraph "Monitoring & Observability"
            LA[Log Analytics Workspace<br/>Logs/Metrics/KQL]
            AppInsights[Application Insights<br/>Distributed Tracing/APM]
        end
    end

    %% Data Flow - IoT Device Ingestion
    IoT -->|MQTT/AMQP/HTTPS| EdgeGateway
    EdgeGateway -->|IoT Edge Modules| IoTHub
    IoT -->|Direct Connection| IoTHub
    DPS -.->|Auto-provision devices| IoTHub
    IoTHub -->|Built-in Endpoint<br/>Event Hub compatible| EventHub
    IoTHub -->|Device Events| EG
    IoTHub -.->|Update Twin| DigitalTwins

    %% Stream Processing
    EventHub -->|Hot Path| StreamAnalytics
    StreamAnalytics -->|Real-time Metrics| ACA
    EventHub -->|Cold Path| ACA

    %% Application Layer
    ACA -->|Publish Processed Events| EG
    EG -->|Route Events| EventHub
    ACA -.->|Write Telemetry| PE_ADLS
    PE_ADLS -.-> ADLS
    ACA -.->|Store Metadata| PE_PG
    PE_PG -.-> Postgres

    %% Analytics Pipeline
    ADLS -->|Source Data| Synapse
    Synapse -->|Export Datasets| Fabric
    DigitalTwins -.->|Device Context| Synapse

    %% Management Access
    Bastion -.->|SSH/RDP| VM
    VM -.->|Admin Access| Postgres
    VM -.->|Admin Access| Synapse

    %% Security & Identity (Managed Identity flows)
    ACA -.->|Managed Identity| EntraID
    VM -.->|Managed Identity| EntraID
    Synapse -.->|Managed Identity| EntraID
    IoTHub -.->|Managed Identity| EntraID
    StreamAnalytics -.->|Managed Identity| EntraID

    %% Private Endpoint Connections
    ACA -.->|Private Link| PE_KV
    PE_KV -.-> KV
    ACA -.->|Private Link| PE_SYN
    PE_SYN -.-> Synapse
    ACA -.->|Private Link| PE_IOT
    PE_IOT -.-> IoTHub
    StreamAnalytics -.->|Private Link| PE_EH
    PE_EH -.-> EventHub

    %% RBAC Assignments via Managed Identity
    EntraID -.->|RBAC: Storage Blob<br/>Data Contributor| ADLS
    EntraID -.->|RBAC: Key Vault<br/>Secrets User| KV
    EntraID -.->|RBAC: PostgreSQL<br/>Reader/Writer| Postgres
    EntraID -.->|RBAC: Synapse<br/>Contributor| Synapse
    EntraID -.->|RBAC: IoT Hub<br/>Data Contributor| IoTHub
    EntraID -.->|RBAC: Event Hubs<br/>Data Receiver| EventHub

    %% Monitoring & Observability
    ACA -.->|Logs/Metrics| LA
    VM -.->|Logs/Metrics| LA
    Postgres -.->|Query Logs| LA
    Synapse -.->|Pipeline Logs| LA
    ADLS -.->|Diagnostic Logs| LA
    KV -.->|Audit Logs| LA
    IoTHub -.->|Device Telemetry Logs| LA
    EventHub -.->|Throughput Metrics| LA
    StreamAnalytics -.->|Job Logs| LA

    ACA -.->|Telemetry/Traces| AppInsights
    AppInsights -->|Analytics| LA

    %% Device Management
    VM -.->|Manage Devices| IoTHub
    ACA -.->|C2D Messages| IoTHub

    %% Styling
    classDef security fill:#f9f,stroke:#333,stroke-width:2px
    classDef monitoring fill:#ff9,stroke:#333,stroke-width:2px
    classDef compute fill:#9cf,stroke:#333,stroke-width:2px
    classDef storage fill:#9f9,stroke:#333,stroke-width:2px
    classDef iot fill:#c9f,stroke:#333,stroke-width:2px
    classDef network fill:#fcc,stroke:#333,stroke-width:1px,stroke-dasharray: 5 5

    class KV,EntraID security
    class LA,AppInsights monitoring
    class ACA,VM,Synapse,Fabric,StreamAnalytics compute
    class ADLS,Blob,Postgres storage
    class IoTHub,DPS,DigitalTwins,EdgeGateway iot
    class PE_KV,PE_ADLS,PE_PG,PE_SYN,PE_IOT,PE_EH network
